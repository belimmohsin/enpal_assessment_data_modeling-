version: 2

models:
  - name: int_deal_stage_history
    description: "Tracking the entry and exit time for every stage a deal entered. (SCD Type 2 view) "
    columns:
      - name: deal_id
        tests:
          - not_null
      - name: stage_id
        tests:
          - not_null
      - name: stage_enter_at
        tests:
          - not_null

    # CRITICAL TEST: The primary key must be unique to ensure no duplicates were created by the LEAD() function.
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - deal_id
            - stage_enter_at

  - name: int_activity_monthly
    description: "Monthly aggregation of completed sales calls and meetings per deal."
    columns:
      - name: deal_id
        tests:
          - not_null
      - name: month_start_date
        tests:
          - not_null
      - name: kpi_name
        description: "Standardized and cleaned** name of the activity (e.g., 'Sales Call 1')."
        tests:
          - not_null
      - name: activities_count
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"


  - name: int_field_options
    description: "Flattened lookup table for stage IDs and Lost Reasons from Pipedrive metadata."
    columns:
      - name: lookup_id
        tests:
          - not_null
      - name: lookup_label
        description: "Standardized and cleaned label for the stage or lost reason (e.g., 'Lead Generation')."
        tests:
          - not_null